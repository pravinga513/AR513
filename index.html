<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VingaDeck Hub | The AR Business Card Ecosystem</title>
    
    <!-- Frameworks & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,400;0,700;0,900;1,900&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --brand-yellow: #eab308;
            --zinc-900: #18181b;
            --zinc-950: #09090b;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: var(--zinc-950); color: #f4f4f5; scroll-behavior: smooth; overflow-x: hidden; }
        .heading-font { font-family: 'Exo 2', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .perspective-1000 { perspective: 1000px; }
        .rotate-x-60 { transform: rotateX(60deg); }
        .animate-spin-slow { animation: spin 15s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            #card-front, #card-back { 
                box-shadow: none !important; 
                border: 3px solid #000 !important;
                margin: 40px auto !important;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact;
            }
        }

        .glass { background: rgba(24, 24, 27, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background-color: var(--brand-yellow); color: black; font-weight: 800; transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(234, 179, 8, 0.3); }
        
        input[type="range"] { appearance: none; background: #27272a; height: 6px; border-radius: 5px; width: 100%; }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 18px; height: 18px; background: var(--brand-yellow);
            border-radius: 50%; cursor: pointer; border: 3px solid #09090b;
        }

        .tab-active { color: var(--brand-yellow); border-bottom: 3px solid var(--brand-yellow); background: rgba(255,255,255,0.03); }
        .hidden-view { display: none !important; }
        
        .shimmer {
            background: linear-gradient(90deg, #18181b 25%, #27272a 50%, #18181b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { to { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100">

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-[300] transform translate-x-full transition-transform duration-300">
        <div class="glass px-6 py-3 rounded-2xl flex items-center gap-3 shadow-2xl">
            <div id="toast-icon" class="text-yellow-500"></div>
            <span id="toast-msg" class="text-sm font-bold"></span>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav class="border-b border-zinc-800 p-4 bg-zinc-900/80 backdrop-blur-xl sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="navigateTo('landing')">
                <div class="bg-yellow-500 p-1.5 rounded-lg group-hover:rotate-12 transition-transform">
                    <i data-lucide="layers" class="text-black w-5 h-5"></i>
                </div>
                <h1 class="font-black text-xl tracking-tighter uppercase heading-font">VINGADECK<span class="text-yellow-500 font-light">HUB</span></h1>
            </div>
            
            <div class="flex items-center gap-6" id="nav-auth-controls">
                <div class="hidden md:flex items-center gap-6 text-xs font-black uppercase tracking-widest text-zinc-500">
                    <button onclick="navigateTo('landing')" class="hover:text-white transition-colors">Home</button>
                    <button onclick="navigateTo('showcase')" class="hover:text-white transition-colors">Showcase</button>
                </div>

                <div id="nav-guest" class="flex items-center gap-4">
                    <button onclick="navigateTo('login')" class="text-sm font-bold text-zinc-400 hover:text-white transition-colors">Login</button>
                    <button onclick="navigateTo('signup')" class="btn-primary px-6 py-2 rounded-xl text-xs uppercase tracking-widest shadow-lg shadow-yellow-500/10">Join Free</button>
                </div>

                <div id="nav-user" class="hidden flex items-center gap-4">
                    <div class="h-8 w-[1px] bg-zinc-800 mx-2 hidden md:block"></div>
                    <button onclick="navigateTo('dashboard')" class="text-sm font-bold text-zinc-400 hover:text-white flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/5 transition-all">
                        <i data-lucide="layout" class="w-4 h-4 text-yellow-500"></i> Dashboard
                    </button>
                    <button onclick="handleLogout()" class="p-2 rounded-xl bg-zinc-800 text-zinc-400 hover:text-red-500 transition-all border border-zinc-700 hover:border-red-500/30">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- VIEW: LANDING -->
    <div id="view-landing" class="min-h-screen no-print relative">
        <div class="max-w-7xl mx-auto px-6 pt-32 pb-20 text-center relative z-10">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-yellow-500/20 bg-yellow-500/5 text-yellow-500 text-[10px] font-black uppercase tracking-[0.2em] mb-8">
                <i data-lucide="sparkles" class="w-3 h-3"></i> The Future of Networking
            </div>
            <h2 class="text-6xl md:text-8xl font-black heading-font tracking-tighter mb-8 leading-[0.9] text-white">
                Physical cards. <br><span class="text-yellow-500">Virtual Dimensions.</span>
            </h2>
            <p class="max-w-xl mx-auto text-zinc-400 mb-12 text-lg leading-relaxed">
                Transform any standard business card into a digital gateway. Host your links, projects, and identity in a browser-native AR environment.
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-5">
                <button onclick="startFreeCard()" class="btn-primary px-12 py-5 rounded-[24px] text-sm uppercase tracking-widest shadow-2xl">Start Building Now</button>
                <button onclick="navigateTo('showcase')" class="bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 px-12 py-5 rounded-[24px] text-sm font-bold transition-all flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-4 h-4"></i> See Demo
                </button>
            </div>
        </div>
    </div>

    <!-- VIEW: SHOWCASE -->
    <div id="view-showcase" class="hidden-view min-h-screen no-print py-20 px-6">
        <div class="max-w-7xl mx-auto text-center">
            <h2 class="text-5xl font-black heading-font tracking-tighter mb-12 uppercase">Artifact <span class="text-yellow-500">Showcase</span></h2>
            <div class="grid md:grid-cols-2 gap-10">
                <div class="glass p-10 rounded-[40px] text-left">
                    <img src="https://api.dicebear.com/7.x/shapes/svg?seed=Creative" class="h-40 mb-6" alt="Creative Template" />
                    <h3 class="text-2xl font-bold mb-2 text-white">The Creative Director</h3>
                    <p class="text-zinc-500 mb-6 italic">Optimized for high-impact visual artists.</p>
                    <button onclick="startFreeCard()" class="text-yellow-500 font-bold uppercase text-xs tracking-widest border-b border-yellow-500 pb-1">Use Template</button>
                </div>
                <div class="glass p-10 rounded-[40px] text-left">
                    <img src="https://api.dicebear.com/7.x/shapes/svg?seed=Tech" class="h-40 mb-6" alt="Tech Template" />
                    <h3 class="text-2xl font-bold mb-2 text-white">The Tech Lead</h3>
                    <p class="text-zinc-500 mb-6 italic">Perfect for developers and engineers.</p>
                    <button onclick="startFreeCard()" class="text-yellow-500 font-bold uppercase text-xs tracking-widest border-b border-yellow-500 pb-1">Use Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: AUTH -->
    <div id="view-auth" class="hidden-view min-h-[85vh] flex items-center justify-center p-6 no-print">
        <div class="glass w-full max-w-md p-10 rounded-[48px] shadow-2xl">
            <div class="mb-10 text-center">
                <h2 id="auth-title" class="text-4xl font-black heading-font tracking-tighter mb-2 text-white text-center">Login</h2>
                <p id="auth-subtitle" class="text-zinc-500 text-sm text-center">Welcome back to the Hub.</p>
            </div>
            
            <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-5">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase text-zinc-500 font-black ml-2 tracking-widest">Email</label>
                    <input type="email" id="auth-email" required class="w-full bg-zinc-900 border border-zinc-800 rounded-2xl p-5 text-sm outline-none focus:border-yellow-500 text-white transition-all" placeholder="user@example.com">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase text-zinc-500 font-black ml-2 tracking-widest">Password</label>
                    <input type="password" id="auth-password" required class="w-full bg-zinc-900 border border-zinc-800 rounded-2xl p-5 text-sm outline-none focus:border-yellow-500 text-white transition-all" placeholder="At least 6 characters">
                </div>
                <button type="submit" id="auth-submit" class="btn-primary w-full py-5 rounded-2xl flex justify-center items-center gap-3 active:scale-95 transition-all">
                    <span id="auth-btn-text" class="uppercase tracking-widest text-xs">Verify Hub Identity</span>
                    <div id="auth-loader" class="hidden w-4 h-4 border-2 border-black/30 border-t-black rounded-full animate-spin"></div>
                </button>
            </form>
            
            <div class="mt-10 text-center">
                <button id="auth-toggle" onclick="toggleAuthMode()" class="text-[10px] font-black text-zinc-500 uppercase tracking-[0.2em] hover:text-yellow-500 transition-colors">No account? Join the hub</button>
            </div>
        </div>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="hidden-view min-h-screen p-8 md:p-16 no-print">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-16">
                <div>
                    <h2 class="text-5xl font-black heading-font tracking-tighter text-white uppercase italic">Active <span class="text-yellow-500">Decks</span></h2>
                    <p class="text-zinc-500 font-medium tracking-wide">Update your virtual layer instantly.</p>
                </div>
                <button onclick="createNewDeck()" class="btn-primary px-10 py-4 rounded-2xl uppercase tracking-widest text-xs shadow-2xl">
                    <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i> New Build
                </button>
            </div>
            <div id="decks-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
            <div id="decks-empty" class="hidden py-32 text-center glass rounded-[60px] border-dashed border-zinc-800">
                <div class="mb-4 text-zinc-700 flex justify-center"><i data-lucide="inbox" class="w-12 h-12"></i></div>
                <p class="text-zinc-500 font-bold uppercase tracking-widest text-sm">No artifacts initialized.</p>
            </div>
        </div>
    </div>

    <!-- VIEW: STUDIO -->
    <div id="view-studio" class="hidden-view min-h-screen flex flex-col no-print bg-[#080808]">
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <aside class="w-full md:w-[420px] border-r border-zinc-800 bg-zinc-900/40 flex flex-col overflow-y-auto scrollbar-hide">
                <div class="flex border-b border-zinc-800 sticky top-0 bg-zinc-950 z-20 shadow-2xl">
                    <button onclick="switchTab('physical')" id="tab-physical" class="flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] tab-active transition-all">Physical</button>
                    <button onclick="switchTab('ar')" id="tab-ar" class="flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500 transition-all">Virtual</button>
                </div>

                <div class="p-8 space-y-10 pb-40">
                    <div id="section-physical" class="space-y-6">
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black uppercase text-zinc-500 flex items-center gap-2"><i data-lucide="shield" class="w-3 h-3 text-yellow-500"></i> Artifact ID</h3>
                            <input type="text" id="input-cardHolder" oninput="updateData('cardHolder', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-sm text-white outline-none focus:border-yellow-500" placeholder="Full Name">
                            <input type="text" id="input-brandTitle" oninput="updateData('brandTitle', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-sm text-white outline-none focus:border-yellow-500" placeholder="Role / Company">
                            <input type="text" id="input-profilePic" oninput="updateData('profilePic', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-xs font-mono text-zinc-400 outline-none focus:border-yellow-500" placeholder="Avatar URL">
                        </div>
                        <div class="pt-6 border-t border-zinc-800 flex gap-4">
                            <div class="flex-1">
                                <label class="text-[9px] uppercase text-zinc-500 font-black mb-2 block">Card</label>
                                <input type="color" id="input-cardColor" oninput="updateData('cardColor', this.value)" class="w-full h-12 rounded-xl bg-zinc-950 border border-zinc-800 cursor-pointer p-1">
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] uppercase text-zinc-500 font-black mb-2 block">Text</label>
                                <input type="color" id="input-textColor" oninput="updateData('textColor', this.value)" class="w-full h-12 rounded-xl bg-zinc-950 border border-zinc-800 cursor-pointer p-1">
                            </div>
                        </div>
                    </div>

                    <div id="section-ar" class="hidden space-y-8">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Interactive Nodes</h3>
                                <button onclick="addLink()" class="text-yellow-500 p-2 bg-yellow-500/10 rounded-lg hover:bg-yellow-500 hover:text-black transition-all"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            <div id="links-container" class="space-y-3"></div>
                        </div>
                        
                        <div class="pt-6 border-t border-zinc-800 space-y-6">
                            <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Virtual Display</h3>
                            <div class="space-y-4">
                                <input type="text" id="input-arTitle" oninput="updateData('arTitle', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-sm text-white outline-none focus:border-yellow-500" placeholder="3D Panel Header">
                                <div>
                                    <div class="flex justify-between text-[9px] font-black uppercase text-zinc-500 mb-3">
                                        <span>Tilt Rotation</span>
                                        <span id="tilt-value" class="text-yellow-500">-60°</span>
                                    </div>
                                    <input type="range" id="input-tiltAngle" min="-90" max="0" step="5" oninput="updateData('tiltAngle', this.value)" class="cursor-pointer">
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase text-zinc-500 font-black mb-2 block">Panel Opacity</label>
                                    <input type="range" id="input-panelOpacity" min="0.1" max="1.0" step="0.1" oninput="updateData('panelOpacity', this.value)" class="cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-auto p-10 bg-zinc-950/80 backdrop-blur-xl border-t border-zinc-800/50 flex justify-between items-center sticky bottom-0">
                    <div class="flex items-center gap-3">
                        <div id="db-status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                        <span id="db-status-text" class="text-[10px] font-black uppercase text-zinc-500 tracking-tighter">Ready to Sync</span>
                    </div>
                    <button onclick="saveExperience()" id="save-btn" class="bg-yellow-500 text-black px-10 py-4 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] active:scale-95 transition-all shadow-xl">Push to Cloud</button>
                </div>
            </aside>

            <section class="flex-1 bg-zinc-950 flex flex-col items-center justify-center p-12 relative overflow-y-auto">
                <div id="preview-workspace" class="relative mt-12 print-area flex items-center justify-center w-full transition-all duration-700 transform scale-90 md:scale-100"></div>

                <div class="absolute bottom-12 flex gap-4 w-full justify-center px-10">
                    <button onclick="launchAR()" class="btn-primary px-12 py-5 rounded-3xl text-[11px] uppercase tracking-widest shadow-[0_20px_50px_rgba(234,179,8,0.2)]">Launch Web-Lens</button>
                    <button onclick="window.print()" class="bg-zinc-800 text-zinc-400 border border-zinc-700 px-10 py-5 rounded-3xl text-[11px] font-black uppercase hover:text-white transition-all">Print PDF</button>
                </div>
            </section>
        </main>
    </div>

    <!-- AR VIEWPORT OVERLAY -->
    <div id="view-ar-mode" class="fixed inset-0 z-[500] bg-black hidden flex flex-col">
        <div class="absolute top-8 left-8 z-[510]">
            <button onclick="closeAR()" class="bg-zinc-900/90 backdrop-blur-xl text-white px-8 py-4 rounded-[28px] text-[10px] font-black border border-white/10 shadow-3xl flex items-center gap-4 active:scale-95 uppercase tracking-widest">
                <i data-lucide="chevron-left" class="w-4 h-4"></i> Exit AR Matrix
            </button>
        </div>
        <div id="ar-iframe-container" class="flex-1"></div>
    </div>

    <script>
        const supabaseUrl = "https://rezjjmsbxiixeieszait.supabase.co"; 
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlempqbXNieGlpeGVpZXN6YWl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDM2MDYsImV4cCI6MjA4NTc3OTYwNn0.Mdaa1siGcWR9MPZXlBn3MTLGAzENJrUWGAb6akK3wyk"; 
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        let user = null;
        let authMode = 'login';
        let currentTab = 'physical';
        let currentCardId = null;
        let appData = getDefaultData();

        function getDefaultData() {
            return {
                cardHolder: "ALEX VINGA",
                brandTitle: "CREATIVE HUB",
                cardColor: "#ffffff",
                textColor: "#000000",
                profilePic: "https://api.dicebear.com/7.x/shapes/svg?seed=Vinga",
                arTitle: "AR EXPERIENCE",
                arSubtitle: "Scan. Connect. Innovate.",
                themeColor: "#FFD700",
                panelOpacity: 0.9,
                tiltAngle: -60,
                links: [{ label: "INSTAGRAM", url: "https://instagram.com", color: "#E1306C" }]
            };
        }

        window.onload = async () => {
            lucide.createIcons();
            const { data } = await supabaseClient.auth.getSession();
            user = data.session?.user || null;
            updateNav();
            checkUrlParams();
            updateDBStatus();
        };

        function updateNav() {
            const guestNav = document.getElementById('nav-guest');
            const userNav = document.getElementById('nav-user');
            if(guestNav) guestNav.classList.toggle('hidden', !!user);
            if(userNav) userNav.classList.toggle('hidden', !user);
        }

        function updateDBStatus() {
            const dot = document.getElementById('db-status-dot');
            const text = document.getElementById('db-status-text');
            if (user) {
                dot.className = "w-2 h-2 rounded-full bg-green-500";
                text.innerText = "Linked to Cloud";
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.innerText = "Logged Out";
            }
        }

        function navigateTo(viewName) {
            const views = ['landing', 'auth', 'dashboard', 'studio', 'showcase'];
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) el.classList.add('hidden-view');
            });

            if (viewName === 'login' || viewName === 'signup') {
                const authEl = document.getElementById('view-auth');
                if(authEl) authEl.classList.remove('hidden-view');
                authMode = viewName;
                toggleAuthMode();
            } else {
                const target = document.getElementById('view-' + viewName);
                if (target) target.classList.remove('hidden-view');
                else document.getElementById('view-landing').classList.remove('hidden-view');
            }

            if (viewName === 'dashboard') loadDecks();
            if (viewName === 'studio') { syncInputs(); renderUI(); }
            lucide.createIcons();
            window.scrollTo(0,0);
        }

        function toggleAuthMode() {
            const title = document.getElementById('auth-title');
            const toggleBtn = document.getElementById('auth-toggle');
            const btnText = document.getElementById('auth-btn-text');
            if(title) title.innerText = authMode === 'login' ? 'Nexus Login' : 'Nexus Registry';
            if(toggleBtn) toggleBtn.innerText = authMode === 'login' ? "New member? Register" : "Have access? Login";
            if(btnText) btnText.innerText = authMode === 'login' ? 'Authorize Identity' : 'Initialize Account';
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const loader = document.getElementById('auth-loader');
            const btnText = document.getElementById('auth-btn-text');
            
            if(loader) loader.classList.remove('hidden');
            if(btnText) btnText.classList.add('hidden');

            try {
                let res;
                if (authMode === 'login') {
                    res = await supabaseClient.auth.signInWithPassword({ email, password });
                } else {
                    res = await supabaseClient.auth.signUp({ email, password });
                }

                if (res.error) throw res.error;
                
                if (res.data.user && res.data.session) {
                    user = res.data.user;
                    updateNav();
                    updateDBStatus();
                    navigateTo('dashboard');
                    showToast("Nexus Verified", "success");
                } else if (res.data.user && !res.data.session) {
                    showToast("Account Created. Please check your email inbox.", "success");
                    navigateTo('login');
                }
            } catch (err) {
                // Specific helpful messages for common Supabase errors
                let msg = err.message;
                if (msg.includes("blocked by client")) msg = "Error: Connection blocked. Please disable your Ad-Blocker.";
                if (msg.includes("Invalid login credentials")) msg = "Error: Invalid email or password.";
                if (msg.includes("Signup requires a minimum password length")) msg = "Error: Password must be at least 6 characters.";
                
                showToast(msg, "error");
            } finally {
                if(loader) loader.classList.add('hidden');
                if(btnText) btnText.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            user = null;
            updateNav();
            updateDBStatus();
            navigateTo('landing');
            showToast("Nexus Disconnected", "success");
        }

        async function loadDecks() {
            if (!user) return;
            const grid = document.getElementById('decks-grid');
            if(!grid) return;
            grid.innerHTML = '<div class="col-span-full py-10 text-center text-zinc-500 uppercase font-black text-xs">Accessing Nexus...</div>';
            
            const { data, error } = await supabaseClient.from('cards').select('*').order('updated_at', { ascending: false });
            
            if (error) {
                showToast("Nexus Connection Error: Check if 'cards' table exists.", "error");
                return;
            }

            grid.innerHTML = (data || []).map(deck => `
                <div class="glass p-8 rounded-[40px] border border-white/5 hover:border-yellow-500/50 transition-all duration-500">
                    <div class="h-24 bg-zinc-900/50 rounded-2xl mb-6 flex items-center justify-center">
                        <div class="w-12 h-8 rounded border border-white/20 shadow-2xl" style="background-color: ${deck.config.cardColor}"></div>
                    </div>
                    <h4 class="font-black heading-font text-white mb-1 truncate uppercase tracking-tighter">${deck.config.cardHolder}</h4>
                    <p class="text-[9px] mono text-zinc-600 mb-6 uppercase tracking-widest">${deck.id}</p>
                    <div class="flex gap-2">
                        <button onclick="editDeck('${deck.id}')" class="flex-1 bg-zinc-800 text-[9px] font-black uppercase tracking-widest py-3 rounded-xl hover:bg-zinc-700">Open</button>
                        <button onclick="deleteDeck('${deck.id}')" class="p-3 bg-red-500/5 text-red-500 hover:bg-red-500 hover:text-white rounded-xl transition-all border border-red-500/10"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                </div>`).join('');
            const empty = document.getElementById('decks-empty');
            if(empty) empty.classList.toggle('hidden', data?.length > 0);
            lucide.createIcons();
        }

        async function editDeck(id) {
            currentCardId = id;
            const { data } = await supabaseClient.from('cards').select('config').eq('id', id).single();
            if(data) {
                appData = data.config;
                navigateTo('studio');
            }
        }

        async function deleteDeck(id) {
            if (!confirm("Permanent Deletion?")) return;
            await supabaseClient.from('cards').delete().eq('id', id);
            loadDecks();
        }

        function createNewDeck() {
            currentCardId = Math.random().toString(36).substring(2, 9).toUpperCase();
            appData = getDefaultData();
            navigateTo('studio');
        }

        function startFreeCard() { user ? navigateTo('dashboard') : navigateTo('signup'); }

        function updateData(key, value) {
            appData[key] = value;
            if (key === 'tiltAngle') {
                const tv = document.getElementById('tilt-value');
                if(tv) tv.innerText = value + "°";
            }
            renderUI();
        }

        function syncInputs() {
            const fields = ['cardHolder', 'brandTitle', 'profilePic', 'cardColor', 'textColor', 'arTitle', 'tiltAngle', 'panelOpacity'];
            fields.forEach(f => {
                const el = document.getElementById('input-' + f);
                if(el) el.value = appData[f] || "";
            });
            const tv = document.getElementById('tilt-value');
            if(tv) tv.innerText = appData.tiltAngle + "°";
        }

        function switchTab(tab) {
            currentTab = tab;
            const pt = document.getElementById('tab-physical');
            const at = document.getElementById('tab-ar');
            const ps = document.getElementById('section-physical');
            const as = document.getElementById('section-ar');
            const cl = document.getElementById('canvas-label');

            if(pt) pt.className = "flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] transition-all " + (tab === 'physical' ? 'tab-active' : 'text-zinc-500');
            if(at) at.className = "flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] transition-all " + (tab === 'ar' ? 'tab-active' : 'text-zinc-500');
            if(ps) ps.classList.toggle('hidden', tab !== 'physical');
            if(as) as.classList.toggle('hidden', tab !== 'ar');
            if(cl) cl.innerText = tab === 'physical' ? 'Previewing Build' : 'Previewing Virtual Matrix';
            renderUI();
        }

        function renderLinksList() {
            const container = document.getElementById('links-container');
            if(!container) return;
            container.innerHTML = appData.links.map((link, idx) => `
                <div class="p-4 bg-zinc-950 border border-zinc-800 rounded-2xl relative shadow-2xl">
                    <button onclick="removeLink(${idx})" class="absolute top-2 right-2 text-zinc-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                    <input type="text" value="${link.label}" oninput="updateLink(${idx}, 'label', this.value.toUpperCase())" class="w-full bg-transparent text-[10px] font-black tracking-widest text-yellow-500 outline-none border-b border-white/5 mb-3">
                    <input type="text" value="${link.url}" oninput="updateLink(${idx}, 'url', this.value)" class="w-full bg-transparent text-[10px] text-zinc-500 outline-none">
                    <input type="color" value="${link.color}" oninput="updateLink(${idx}, 'color', this.value)" class="w-full h-1 mt-2 bg-zinc-800 rounded-full border-none appearance-none cursor-pointer">
                </div>`).join('');
            lucide.createIcons();
        }

        function updateLink(idx, field, val) { appData.links[idx][field] = val; renderUI(); }
        function addLink() { appData.links.push({ label: "NEW NODE", url: "https://", color: "#333333" }); renderUI(); }
        function removeLink(idx) { appData.links.splice(idx, 1); renderUI(); }

        async function saveExperience() {
            if (!user) { navigateTo('login'); return; }
            const btn = document.getElementById('save-btn');
            const status = document.getElementById('db-status-text');
            const dot = document.getElementById('db-status-dot');
            if(btn) btn.innerText = "Syncing...";
            
            try {
                const { error } = await supabaseClient.from('cards').upsert({ 
                    id: currentCardId, 
                    user_id: user.id, 
                    config: appData, 
                    updated_at: new Date().toISOString() 
                });
                
                if (error) throw error;
                
                showToast("Nexus Synced", "success");
                if(status) status.innerText = "Cloud Updated";
                if(dot) dot.className = "w-2 h-2 rounded-full bg-green-500";
            } catch (e) { 
                console.error("Save error:", e);
                let msg = e.message;
                if (msg.includes("400")) msg = "Error 400: Check if 'cards' table and columns exist in Supabase.";
                showToast(msg, "error"); 
            } finally {
                if(btn) btn.innerText = "Push to Cloud";
            }
        }

        function renderUI() {
            const workspace = document.getElementById('preview-workspace');
            if(!workspace) return;
            const cardUrl = window.location.href.split('?')[0] + "?id=" + currentCardId;
            const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?data=" + encodeURIComponent(cardUrl + "&view=ar") + "&size=300x300&bgcolor=ffffff";

            if (currentTab === 'physical') {
                workspace.innerHTML = `
                    <div class="flex flex-col gap-16 items-center w-full max-w-sm">
                        <div id="card-front" class="w-[360px] h-[210px] rounded-[40px] shadow-2xl relative overflow-hidden flex flex-col p-10 border border-white/10" style="background-color: ${appData.cardColor}; color: ${appData.textColor}">
                            <img src="${appData.profilePic}" class="w-16 h-16 rounded-[24px] border-2 border-current/10 bg-white/5 object-cover mb-4">
                            <h2 class="text-3xl font-black italic uppercase leading-none heading-font">${appData.cardHolder}</h2>
                            <p class="text-[10px] opacity-70 uppercase tracking-[0.4em] font-black">${appData.brandTitle}</p>
                            <div class="mt-auto border-t border-current/10 pt-4 text-[9px] mono opacity-40 uppercase tracking-widest">ID_${currentCardId}</div>
                        </div>
                        <div id="card-back" class="w-[360px] h-[210px] bg-white rounded-[40px] shadow-2xl relative overflow-hidden flex items-center p-8 border-2 border-zinc-200">
                            <div class="w-32 h-32 bg-black p-3 rounded-[28px] ring-4 ring-zinc-50 shadow-2xl"><img src="${qrUrl}" class="w-full h-full rounded-lg"></div>
                            <div class="flex-1 pl-10 space-y-4">
                                <p class="text-black text-[10px] font-black leading-tight uppercase opacity-80 italic underline decoration-yellow-500 underline-offset-4">Scan Matrix<br>Deploy Hub</p>
                                <div class="pt-4 border-t border-zinc-100"><div class="text-black text-[18px] font-black italic tracking-tighter leading-none heading-font">VingaDeck Hub</div></div>
                            </div>
                        </div>
                    </div>`;
            } else {
                renderLinksList();
                workspace.innerHTML = `
                    <div class="relative w-full max-w-[480px] h-[520px] flex items-center justify-center perspective-1000">
                        <div class="absolute bottom-10 w-60 h-60 bg-black/40 p-8 rounded-[60px] rotate-x-60 backdrop-blur-3xl border-2 border-white/5 flex items-center justify-center font-black text-white/5 tracking-[0.6em] text-3xl">HIRO</div>
                        <div class="w-80 h-[360px] rounded-[50px] shadow-[0_0_120px_rgba(0,0,0,0.8)] flex flex-col p-10 border-2 transition-all duration-700 ease-out transform-gpu" 
                             style="background-color: #030303; border-color: ${appData.themeColor}; transform: rotateX(${appData.tiltAngle}deg) translateY(-120px) scale(1.1); opacity: ${appData.panelOpacity}; box-shadow: 0 0 60px ${appData.themeColor}1a">
                            <img src="${appData.profilePic}" class="w-16 h-16 rounded-[24px] bg-zinc-900 border-2 border-white/10 shadow-2xl mx-auto mb-4 object-cover">
                            <h3 class="text-2xl font-black italic text-center uppercase heading-font mb-2 leading-none" style="color: ${appData.themeColor}">${appData.arTitle}</h3>
                            <div class="grid grid-cols-2 gap-3 mt-auto">
                                ${appData.links.slice(0, 4).map(l => `<div class="h-9 rounded-[18px] flex items-center justify-center text-[8px] font-black uppercase truncate px-4 text-white border border-white/5" style="background-color: ${l.color}">${l.label}</div>`).join('')}
                            </div>
                        </div>
                    </div>`;
            }
        }

        function launchAR() {
            const arOverlay = document.getElementById('view-ar-mode');
            const arContainer = document.getElementById('ar-iframe-container');
            if(!arOverlay || !arContainer) return;
            arOverlay.classList.remove('hidden');
            const linksHtml = appData.links.map((link, i) => {
                const x = (i % 2 === 0 ? -0.85 : 0.85);
                const y = -Math.floor(i / 2) * 0.5;
                return `<a-plane class="clickable" link-to="url: ${link.url}" position="${x} ${y} 0" width="1.5" height="0.4" color="${link.color}"><a-text value="${link.label}" align="center" color="white" width="3" font="exo2bold"></a-text></a-plane>`;
            }).join('');
            arContainer.innerHTML = `<iframe class="w-full h-full border-none" allow="camera; accelerometer; gyro; magnetometer; xr-spatial-tracking" srcDoc='
                <!DOCTYPE html><html><head><script src="https://aframe.io/releases/1.3.0/aframe.min.js"><\/script><script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"><\/script></head>
                <body style="margin: 0; overflow: hidden;"><script>AFRAME.registerComponent("link-to", {schema: { url: {type: "string"} }, init: function () {this.el.addEventListener("click", function() { window.open(this.data.url, "_blank"); }.bind(this));}});<\/script>
                <a-scene embedded arjs="debugUIEnabled: false; trackingMethod: best;"><a-marker preset="hiro"><a-entity position="0 0.7 -1.2" rotation="${appData.tiltAngle} 0 0">
                <a-plane width="3.6" height="3" color="#030303" opacity="${appData.panelOpacity}" transparent="true" radius="0.3"><a-image src="${appData.profilePic}" position="0 1.1 0.1" width="0.75" height="0.75" radius="0.1"><\/a-image><a-text value="${appData.arTitle}" align="center" position="0 0.55 0.1" color="${appData.themeColor}" width="6.5" font="exo2bold"><\/a-text>
                <a-entity position="0 -0.5 0.1">${linksHtml.replace(/'/g, "&apos;")}<\/a-entity><\/a-plane><a-torus-knot radius="0.15" radius-tubular="0.01" position="1.6 1.2 0.2" color="${appData.themeColor}" animation="property: rotation; to: 0 360 0; loop: true; dur: 6000"><\/a-torus-knot><\/a-entity><\/a-marker>
                <a-entity camera><a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"><\/a-entity><\/a-entity><\/a-scene></body></html>'></iframe>`;
            lucide.createIcons();
        }

        function closeAR() {
            const arOverlay = document.getElementById('view-ar-mode');
            const arContainer = document.getElementById('ar-iframe-container');
            if(arOverlay) arOverlay.classList.add('hidden');
            if(arContainer) arContainer.innerHTML = '';
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = document.getElementById('toast-icon');
            if(!toast || !msgEl || !iconEl) return;
            msgEl.innerText = msg;
            iconEl.innerHTML = type === 'success' ? '<i data-lucide="check-circle" class="text-green-500"></i>' : '<i data-lucide="alert-circle" class="text-red-500"></i>';
            lucide.createIcons();
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 4000);
        }

        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (id) {
                currentCardId = id;
                const { data } = await supabaseClient.from('cards').select('config').eq('id', id).single();
                if (data && data.config) {
                    appData = data.config;
                    params.get('view') === 'ar' ? launchAR() : navigateTo('studio');
                }
            }
        }
    </script>
</body>
</html>
