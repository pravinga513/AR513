<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VingaDeck Hub | The AR Business Card Ecosystem</title>
    
    <!-- Frameworks & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,400;0,700;0,900;1,900&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap');
        
        :root {
            --brand-yellow: #eab308;
            --zinc-900: #18181b;
            --zinc-950: #09090b;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: var(--zinc-950); color: #f4f4f5; scroll-behavior: smooth; overflow-x: hidden; }
        .heading-font { font-family: 'Exo 2', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .perspective-1000 { perspective: 1000px; }
        .rotate-x-60 { transform: rotateX(60deg); }
        .animate-spin-slow { animation: spin 15s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            #card-front, #card-back { 
                box-shadow: none !important; 
                border: 3px solid #000 !important;
                margin: 40px auto !important;
                page-break-inside: avoid;
            }
        }

        .glass { background: rgba(24, 24, 27, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background-color: var(--brand-yellow); color: black; font-weight: 800; transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(234, 179, 8, 0.3); }
        
        input[type="range"] { appearance: none; background: #27272a; height: 6px; border-radius: 5px; width: 100%; }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 18px; height: 18px; background: var(--brand-yellow);
            border-radius: 50%; cursor: pointer; border: 3px solid #09090b;
        }

        .tab-active { color: var(--brand-yellow); border-bottom: 3px solid var(--brand-yellow); background: rgba(255,255,255,0.03); }
        .hidden-view { display: none !important; }
        
        /* Shimmer effect for loaders */
        .shimmer {
            background: linear-gradient(90deg, #18181b 25%, #27272a 50%, #18181b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { to { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100">

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-[300] transform translate-x-full transition-transform duration-300">
        <div class="glass px-6 py-3 rounded-2xl flex items-center gap-3 shadow-2xl">
            <div id="toast-icon" class="text-yellow-500"></div>
            <span id="toast-msg" class="text-sm font-bold"></span>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav class="border-b border-zinc-800 p-4 bg-zinc-900/80 backdrop-blur-xl sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="navigateTo('landing')">
                <div class="bg-yellow-500 p-1.5 rounded-lg group-hover:rotate-12 transition-transform">
                    <i data-lucide="layers" class="text-black w-5 h-5"></i>
                </div>
                <h1 class="font-black text-xl tracking-tighter uppercase heading-font">VINGADECK<span class="text-yellow-500 font-light">HUB</span></h1>
            </div>
            
            <div class="flex items-center gap-6" id="nav-auth-controls">
                <!-- Links (Desktop) -->
                <div class="hidden md:flex items-center gap-6 text-xs font-black uppercase tracking-widest text-zinc-500">
                    <button onclick="navigateTo('landing')" class="hover:text-white transition-colors">Home</button>
                    <button onclick="navigateTo('showcase')" class="hover:text-white transition-colors">Showcase</button>
                </div>

                <!-- Guest State -->
                <div id="nav-guest" class="flex items-center gap-4">
                    <button onclick="navigateTo('login')" class="text-sm font-bold text-zinc-400 hover:text-white transition-colors">Login</button>
                    <button onclick="navigateTo('signup')" class="btn-primary px-6 py-2 rounded-xl text-xs uppercase tracking-widest shadow-lg shadow-yellow-500/10">Join Free</button>
                </div>

                <!-- User State -->
                <div id="nav-user" class="hidden flex items-center gap-4">
                    <div class="h-8 w-[1px] bg-zinc-800 mx-2 hidden md:block"></div>
                    <button onclick="navigateTo('dashboard')" class="text-sm font-bold text-zinc-400 hover:text-white flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/5 transition-all">
                        <i data-lucide="layout" class="w-4 h-4 text-yellow-500"></i> Dashboard
                    </button>
                    <button onclick="handleLogout()" class="p-2 rounded-xl bg-zinc-800 text-zinc-400 hover:text-red-500 transition-all border border-zinc-700 hover:border-red-500/30">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- VIEW: LANDING -->
    <div id="view-landing" class="min-h-screen no-print overflow-hidden relative">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full pointer-events-none">
            <div class="absolute top-20 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-yellow-500/10 rounded-full blur-[120px]"></div>
        </div>

        <div class="max-w-7xl mx-auto px-6 pt-32 pb-20 text-center relative z-10">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-yellow-500/20 bg-yellow-500/5 text-yellow-500 text-[10px] font-black uppercase tracking-[0.2em] mb-8">
                <i data-lucide="sparkles" class="w-3 h-3"></i> The Future of Networking
            </div>
            <h2 class="text-6xl md:text-8xl font-black heading-font tracking-tighter mb-8 leading-[0.9] text-white">
                Physical cards. <br><span class="text-yellow-500">Virtual Dimensions.</span>
            </h2>
            <p class="max-w-xl mx-auto text-zinc-400 mb-12 text-lg leading-relaxed">
                Transform any standard business card into a digital gateway. Host your links, projects, and identity in a browser-native AR environment.
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-5">
                <button onclick="startFreeCard()" class="btn-primary px-12 py-5 rounded-[24px] text-sm uppercase tracking-widest shadow-2xl">Start Building Now</button>
                <button onclick="navigateTo('showcase')" class="bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 px-12 py-5 rounded-[24px] text-sm font-bold transition-all flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-4 h-4"></i> See Demo
                </button>
            </div>
            
            <!-- Live Preview Ticker -->
            <div class="mt-40 pt-10 border-t border-white/5 opacity-50 flex flex-wrap justify-center gap-12 grayscale hover:grayscale-0 transition-all duration-500">
                <div class="flex items-center gap-2 text-sm font-bold tracking-tighter"><i data-lucide="shield-check"></i> Enterprise Security</div>
                <div class="flex items-center gap-2 text-sm font-bold tracking-tighter"><i data-lucide="zap"></i> Instant Loading</div>
                <div class="flex items-center gap-2 text-sm font-bold tracking-tighter"><i data-lucide="globe"></i> Globally Available</div>
            </div>
        </div>
    </div>

    <!-- VIEW: AUTH -->
    <div id="view-auth" class="hidden-view min-h-[85vh] flex items-center justify-center p-6 no-print">
        <div class="glass w-full max-w-md p-10 rounded-[48px] shadow-[0_50px_100px_-20px_rgba(0,0,0,0.5)]">
            <div class="mb-10 text-center">
                <div class="w-16 h-16 bg-yellow-500 rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-2xl rotate-6">
                    <i data-lucide="layers" class="text-black w-8 h-8"></i>
                </div>
                <h2 id="auth-title" class="text-4xl font-black heading-font tracking-tighter mb-2">VingaDeck Login</h2>
                <p id="auth-subtitle" class="text-zinc-500 text-sm">Welcome back to the AR ecosystem.</p>
            </div>
            
            <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-5">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-600 ml-4 tracking-widest">Email Address</label>
                    <input type="email" id="auth-email" required class="w-full bg-zinc-900/50 border border-zinc-800 rounded-2xl p-5 text-sm outline-none focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/10 transition-all" placeholder="name@domain.com">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-600 ml-4 tracking-widest">Secret Key</label>
                    <input type="password" id="auth-password" required class="w-full bg-zinc-900/50 border border-zinc-800 rounded-2xl p-5 text-sm outline-none focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/10 transition-all" placeholder="••••••••">
                </div>
                <button type="submit" id="auth-submit" class="btn-primary w-full py-5 rounded-2xl mt-6 flex justify-center items-center gap-3 active:scale-95">
                    <span id="auth-btn-text" class="uppercase tracking-widest text-xs">Authorize Entry</span>
                    <div id="auth-loader" class="hidden w-4 h-4 border-2 border-black/20 border-t-black rounded-full animate-spin"></div>
                </button>
            </form>
            
            <div class="mt-10 pt-8 border-t border-zinc-800/50 text-center">
                <button id="auth-toggle" onclick="toggleAuthMode()" class="text-xs font-bold text-zinc-500 hover:text-yellow-500 transition-colors uppercase tracking-widest underline underline-offset-4">Create a new hub account</button>
            </div>
        </div>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="hidden-view min-h-screen p-8 md:p-16 no-print">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-8 mb-16">
                <div class="space-y-2">
                    <h2 class="text-5xl font-black heading-font tracking-tighter">Your <span class="text-yellow-500">Decks</span></h2>
                    <p class="text-zinc-500 font-medium tracking-wide">Manage your active augmented reality artifacts.</p>
                </div>
                <button onclick="createNewDeck()" class="btn-primary px-8 py-4 rounded-2xl flex items-center gap-3 uppercase tracking-widest text-xs shadow-2xl">
                    <i data-lucide="plus" class="w-4 h-4"></i> Initiate New Card
                </button>
            </div>

            <div id="decks-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Cards will be dynamically injected -->
            </div>
            
            <div id="decks-empty" class="hidden py-32 text-center glass rounded-[60px] border-dashed border-zinc-800">
                <div class="w-20 h-20 bg-zinc-900 rounded-full mx-auto mb-6 flex items-center justify-center text-zinc-700">
                    <i data-lucide="package-open" class="w-10 h-10"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Workspace Empty</h3>
                <p class="text-zinc-500 text-sm mb-8">You haven't initialized any AR Decks yet.</p>
                <button onclick="createNewDeck()" class="text-yellow-500 font-black uppercase text-xs tracking-[0.2em] border-b-2 border-yellow-500 pb-1">Begin First Project</button>
            </div>
        </div>
    </div>

    <!-- VIEW: STUDIO (ADVANCED EDITOR) -->
    <div id="view-studio" class="hidden-view min-h-screen flex flex-col no-print bg-[#0c0c0e]">
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- Left Panel: Detailed Customization -->
            <aside class="w-full md:w-[420px] border-r border-zinc-800 bg-zinc-900/40 flex flex-col overflow-y-auto scrollbar-hide">
                <div class="flex border-b border-zinc-800 sticky top-0 bg-zinc-900/90 backdrop-blur-md z-20">
                    <button onclick="switchTab('physical')" id="tab-physical" class="flex-1 py-5 text-[11px] font-black uppercase tracking-[0.2em] transition-all tab-active">Artifact Build</button>
                    <button onclick="switchTab('ar')" id="tab-ar" class="flex-1 py-5 text-[11px] font-black uppercase tracking-[0.2em] transition-all text-zinc-500">Virtual Layer</button>
                </div>

                <div class="p-10 space-y-12 pb-40">
                    <!-- Physical Controls -->
                    <div id="section-physical" class="space-y-8 animate-in slide-in-from-left duration-500">
                        <div class="space-y-6">
                            <h3 class="text-[11px] font-black uppercase text-zinc-500 flex items-center gap-3 tracking-[0.3em]"><span class="w-6 h-[1px] bg-yellow-500"></span> Identity</h3>
                            <div class="space-y-4">
                                <div class="group">
                                    <label class="text-[10px] uppercase text-zinc-600 mb-2 block font-black tracking-widest group-focus-within:text-yellow-500 transition-colors">Holder Name</label>
                                    <input type="text" id="input-cardHolder" oninput="updateData('cardHolder', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-sm outline-none focus:border-yellow-500 transition-all font-bold">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase text-zinc-600 mb-2 block font-black tracking-widest">Subtitle / Brand</label>
                                    <input type="text" id="input-brandTitle" oninput="updateData('brandTitle', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-sm outline-none focus:border-yellow-500 transition-all">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase text-zinc-600 mb-2 block font-black tracking-widest">Logo Image URL</label>
                                    <input type="text" id="input-profilePic" oninput="updateData('profilePic', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-xs font-mono outline-none focus:border-yellow-500 transition-all text-zinc-400">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6 pt-8 border-t border-zinc-800/50">
                            <h3 class="text-[11px] font-black uppercase text-zinc-500 flex items-center gap-3 tracking-[0.3em]"><span class="w-6 h-[1px] bg-yellow-500"></span> Appearance</h3>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="text-[10px] uppercase text-zinc-600 mb-3 block font-black">Backing Color</label>
                                    <div class="relative group">
                                        <input type="color" id="input-cardColor" oninput="updateData('cardColor', this.value)" class="w-full h-14 rounded-2xl bg-zinc-950 border border-zinc-800 cursor-pointer p-2 hover:border-zinc-600 transition-all">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase text-zinc-600 mb-3 block font-black">Ink Color</label>
                                    <input type="color" id="input-textColor" oninput="updateData('textColor', this.value)" class="w-full h-14 rounded-2xl bg-zinc-950 border border-zinc-800 cursor-pointer p-2 hover:border-zinc-600 transition-all">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AR Controls -->
                    <div id="section-ar" class="space-y-8 hidden animate-in slide-in-from-right duration-500">
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <h3 class="text-[11px] font-black uppercase text-zinc-500 flex items-center gap-3 tracking-[0.3em]"><span class="w-6 h-[1px] bg-yellow-500"></span> Virtual Nodes</h3>
                                <button onclick="addLink()" class="p-2 bg-yellow-500/10 text-yellow-500 rounded-xl hover:bg-yellow-500 hover:text-black transition-all"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            <div id="links-container" class="space-y-4"></div>
                        </div>
                        
                        <div class="space-y-6 pt-8 border-t border-zinc-800/50">
                            <h3 class="text-[11px] font-black uppercase text-zinc-500 flex items-center gap-3 tracking-[0.3em]"><span class="w-6 h-[1px] bg-yellow-500"></span> 3D Visualization</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[10px] uppercase text-zinc-600 mb-2 block font-black">Hologram Header</label>
                                    <input type="text" id="input-arTitle" oninput="updateData('arTitle', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-sm outline-none focus:border-yellow-500 transition-all font-bold">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase text-zinc-600 mb-2 block font-black">Hologram Info</label>
                                    <input type="text" id="input-arSubtitle" oninput="updateData('arSubtitle', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-sm outline-none focus:border-yellow-500 transition-all">
                                </div>
                                <div class="pt-4">
                                    <div class="flex justify-between items-center text-[10px] text-zinc-500 uppercase font-black mb-4">
                                        <span class="tracking-widest">Tilt Projection</span>
                                        <span id="tilt-value" class="text-yellow-500 mono font-black bg-yellow-500/10 px-2 py-1 rounded">-60°</span>
                                    </div>
                                    <input type="range" id="input-tiltAngle" min="-90" max="0" step="5" oninput="updateData('tiltAngle', this.value)" class="cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Stats -->
                <div class="mt-auto p-10 border-t border-zinc-800/50 bg-zinc-950/50">
                    <div class="flex items-center justify-between gap-4">
                        <div class="space-y-1">
                            <div class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-zinc-400">
                                <div id="db-status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                                <span id="db-status-text">Local Workspace</span>
                            </div>
                            <div id="last-saved-text" class="text-[9px] mono text-zinc-600 uppercase">Unsaved Changes</div>
                        </div>
                        <button onclick="saveExperience()" id="save-btn" class="bg-zinc-800 border border-zinc-700 px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-[0.1em] hover:bg-zinc-700 transition-all active:scale-95 flex items-center gap-2">
                            <i data-lucide="cloud-upload" class="w-4 h-4"></i> Sync
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Center View: Reality Workspace -->
            <section class="flex-1 bg-zinc-950 flex flex-col items-center justify-center p-12 relative overflow-y-auto">
                <!-- Floating Canvas Header -->
                <div class="absolute top-12 flex items-center gap-4 bg-zinc-900/50 px-6 py-2.5 rounded-full border border-white/5 backdrop-blur-md select-none">
                    <div class="w-2 h-2 rounded-full bg-yellow-500 animate-ping"></div>
                    <h2 class="text-zinc-400 text-[10px] font-black uppercase tracking-[0.3em]">Canvas v2.1 Engine</h2>
                    <div class="w-[1px] h-4 bg-white/10"></div>
                    <p id="canvas-label" class="text-white text-[10px] font-black uppercase tracking-[0.2em]">Build Mode</p>
                </div>

                <div id="preview-workspace" class="relative mt-12 print-area flex items-center justify-center w-full transition-all duration-1000 ease-in-out transform scale-90 lg:scale-100">
                    <!-- Dynamic rendering -->
                </div>

                <!-- Footer Interaction Actions -->
                <div class="absolute bottom-12 flex flex-wrap gap-4 w-full px-12 justify-center items-center">
                    <button onclick="launchAR()" class="btn-primary text-[11px] px-12 py-5 rounded-3xl flex items-center gap-3 transition-all uppercase tracking-widest shadow-2xl active:scale-95 group">
                        <i data-lucide="eye" class="w-5 h-5 group-hover:scale-110 transition-transform"></i> Launch Viewport
                    </button>
                    <button onclick="copyPublicLink()" class="glass text-white text-[11px] px-10 py-5 rounded-3xl flex items-center gap-3 transition-all font-black uppercase tracking-widest hover:bg-white/10 active:scale-95">
                        <i data-lucide="copy" class="w-5 h-5 text-yellow-500"></i> Copy Share Link
                    </button>
                    <button onclick="window.print()" class="bg-zinc-800 text-zinc-400 text-[11px] px-10 py-5 rounded-3xl flex items-center gap-3 border border-zinc-700 transition-all font-black uppercase tracking-widest hover:text-white">
                        <i data-lucide="printer" class="w-5 h-5"></i> PDF Export
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- FULLSCREEN AR LAYER -->
    <div id="view-ar-mode" class="fixed inset-0 z-[500] bg-black hidden flex flex-col">
        <div class="absolute top-8 left-8 z-[510]">
            <button onclick="closeAR()" class="bg-zinc-900/80 backdrop-blur-2xl text-white px-8 py-4 rounded-[28px] text-xs font-black border border-white/10 shadow-3xl flex items-center gap-4 active:scale-95 transition-all">
                <i data-lucide="chevron-left" class="w-5 h-5"></i> EXIT AR INTERFACE
            </button>
        </div>
        <div id="ar-iframe-container" class="flex-1"></div>
    </div>

    <script>
        /**
         * SETUP INSTRUCTIONS:
         * 1. Create a Supabase project.
         * 2. Table: 'cards'
         * - id: text (PK)
         * - user_id: uuid (references auth.users)
         * - config: jsonb
         * - updated_at: timestamptz
         * 3. Policies: Enable Insert/Select/Update/Delete for 'authenticated' users.
         */
        const supabaseUrl = "https://rezjjmsbxiixeieszait.supabase.co"; 
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlempqbXNieGlpeGVpZXN6YWl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDM2MDYsImV4cCI6MjA4NTc3OTYwNn0.Mdaa1siGcWR9MPZXlBn3MTLGAzENJrUWGAb6akK3wyk"; 
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // --- State ---
        let user = null;
        let authMode = 'login';
        let currentTab = 'physical';
        let currentCardId = null;
        let appData = getDefaultData();

        function getDefaultData() {
            return {
                cardHolder: "ALEX VINGA",
                brandTitle: "CREATIVE HUB",
                cardColor: "#ffffff",
                textColor: "#000000",
                profilePic: "https://api.dicebear.com/7.x/shapes/svg?seed=Hub",
                arTitle: "AR EXPERIENCE",
                arSubtitle: "Scan. Discover. Connect.",
                themeColor: "#FFD700",
                panelOpacity: 0.9,
                tiltAngle: -60,
                links: [
                    { label: "PORTFOLIO", url: "https://", color: "#222222" },
                    { label: "INSTAGRAM", url: "https://instagram.com", color: "#E1306C" }
                ]
            };
        }

        // --- Initialization ---
        window.onload = async () => {
            lucide.createIcons();
            await checkAuth();
            checkUrlParams();
            renderUI();
        };

        async function checkAuth() {
            const { data } = await supabaseClient.auth.getSession();
            user = data.session?.user || null;
            updateNav();
            if (user && document.getElementById('view-dashboard').className === "") loadDecks();
        }

        function updateNav() {
            document.getElementById('nav-guest').classList.toggle('hidden', !!user);
            document.getElementById('nav-user').classList.toggle('hidden', !user);
        }

        function navigateTo(viewName) {
            ['landing', 'auth', 'dashboard', 'studio'].forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) el.classList.add('hidden-view');
            });
            document.getElementById('view-' + viewName).classList.remove('hidden-view');
            
            if (viewName === 'dashboard') loadDecks();
            if (viewName === 'studio') {
                syncInputs();
                renderUI();
            }
            window.scrollTo(0,0);
            lucide.createIcons();
        }

        // --- Authentication ---
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            document.getElementById('auth-title').innerText = authMode === 'login' ? 'VingaDeck Login' : 'Initialize Account';
            document.getElementById('auth-subtitle').innerText = authMode === 'login' ? 'Welcome back to the AR ecosystem.' : 'Secure your personal holographic portal.';
            document.getElementById('auth-btn-text').innerText = authMode === 'login' ? 'Authorize Entry' : 'Create Identity';
            document.getElementById('auth-toggle').innerText = authMode === 'login' ? "Create a new hub account" : "Existing member? Sign In";
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const loader = document.getElementById('auth-loader');
            const btnText = document.getElementById('auth-btn-text');
            
            loader.classList.remove('hidden');
            btnText.classList.add('hidden');

            try {
                let result;
                if (authMode === 'login') {
                    result = await supabaseClient.auth.signInWithPassword({ email, password });
                } else {
                    result = await supabaseClient.auth.signUp({ email, password });
                }

                if (result.error) throw result.error;
                
                showToast("Identity Confirmed", "success");
                await checkAuth();
                navigateTo('dashboard');
            } catch (err) {
                showToast(err.message, "error");
            } finally {
                loader.classList.add('hidden');
                btnText.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            user = null;
            updateNav();
            navigateTo('landing');
        }

        // --- Dashboard Management ---
        async function loadDecks() {
            const grid = document.getElementById('decks-grid');
            const empty = document.getElementById('decks-empty');
            
            // Show loading shimmers
            grid.innerHTML = Array(4).fill(0).map(() => `<div class="h-64 rounded-[40px] shimmer"></div>`).join('');
            
            const { data, error } = await supabaseClient
                .from('cards')
                .select('*')
                .order('updated_at', { ascending: false });

            if (data && data.length > 0) {
                empty.classList.add('hidden');
                grid.innerHTML = data.map(deck => `
                    <div class="glass p-8 rounded-[48px] group hover:border-yellow-500 transition-all duration-500 hover:shadow-2xl hover:shadow-yellow-500/10">
                        <div class="h-32 bg-zinc-900/50 rounded-3xl mb-8 overflow-hidden flex items-center justify-center border border-white/5 group-hover:scale-105 transition-transform">
                            <div class="w-16 h-10 rounded shadow-2xl border border-white/10" style="background-color: ${deck.config.cardColor};">
                                <div class="text-[3px] p-2 font-black tracking-tighter" style="color: ${deck.config.textColor}">${deck.config.cardHolder}</div>
                            </div>
                        </div>
                        <h4 class="font-black heading-font text-lg mb-1 truncate uppercase tracking-tighter">${deck.config.cardHolder}</h4>
                        <p class="text-[10px] mono text-zinc-600 mb-8 tracking-widest">${deck.id}</p>
                        <div class="flex gap-3">
                            <button onclick="editDeck('${deck.id}')" class="flex-1 bg-zinc-800 hover:bg-zinc-700 py-3.5 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] transition-all">Open Studio</button>
                            <button onclick="deleteDeck('${deck.id}')" class="p-3.5 bg-red-500/5 text-red-500 hover:bg-red-500 hover:text-white rounded-2xl transition-all border border-red-500/10"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        async function editDeck(id) {
            currentCardId = id;
            const { data } = await supabaseClient.from('cards').select('config').eq('id', id).single();
            appData = data.config;
            navigateTo('studio');
        }

        async function deleteDeck(id) {
            if (!confirm("Permanent Deletion Protocol. Proceed?")) return;
            await supabaseClient.from('cards').delete().eq('id', id);
            loadDecks();
        }

        function createNewDeck() {
            currentCardId = Math.random().toString(36).substring(2, 9).toUpperCase();
            appData = getDefaultData();
            navigateTo('studio');
        }

        function startFreeCard() {
            if (!user) navigateTo('signup');
            else navigateTo('dashboard');
        }

        // --- Studio Logic ---
        function updateData(key, value) {
            appData[key] = value;
            if (key === 'tiltAngle') document.getElementById('tilt-value').innerText = value + "°";
            renderUI();
        }

        function syncInputs() {
            document.getElementById('input-cardHolder').value = appData.cardHolder;
            document.getElementById('input-brandTitle').value = appData.brandTitle;
            document.getElementById('input-profilePic').value = appData.profilePic;
            document.getElementById('input-cardColor').value = appData.cardColor;
            document.getElementById('input-textColor').value = appData.textColor;
            document.getElementById('input-arTitle').value = appData.arTitle;
            document.getElementById('input-arSubtitle').value = appData.arSubtitle;
            document.getElementById('input-tiltAngle').value = appData.tiltAngle;
            document.getElementById('tilt-value').innerText = appData.tiltAngle + "°";
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-physical').className = "flex-1 py-5 text-[11px] font-black uppercase tracking-[0.2em] transition-all " + (tab === 'physical' ? 'tab-active' : 'text-zinc-500');
            document.getElementById('tab-ar').className = "flex-1 py-5 text-[11px] font-black uppercase tracking-[0.2em] transition-all " + (tab === 'ar' ? 'tab-active' : 'text-zinc-500');
            document.getElementById('section-physical').classList.toggle('hidden', tab !== 'physical');
            document.getElementById('section-ar').classList.toggle('hidden', tab !== 'ar');
            document.getElementById('canvas-label').innerText = tab === 'physical' ? 'Build Mode' : 'Projection Mode';
            renderUI();
        }

        function renderLinksList() {
            const container = document.getElementById('links-container');
            container.innerHTML = appData.links.map((link, idx) => `
                <div class="p-5 bg-zinc-950/50 border border-zinc-800 rounded-[28px] space-y-3 relative group shadow-2xl">
                    <button onclick="removeLink(${idx})" class="absolute top-3 right-3 text-zinc-600 hover:text-red-500 transition-all p-2 bg-zinc-900 rounded-xl">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    <input type="text" value="${link.label}" oninput="updateLink(${idx}, 'label', this.value.toUpperCase())" class="w-full bg-transparent text-[11px] font-black tracking-widest text-yellow-500 outline-none border-b border-white/5 pb-2" placeholder="NODE LABEL">
                    <input type="text" value="${link.url}" oninput="updateLink(${idx}, 'url', this.value)" class="w-full bg-transparent text-[10px] mono text-zinc-500 outline-none" placeholder="https://domain.com">
                    <div class="flex items-center gap-4 pt-2">
                        <label class="text-[8px] uppercase text-zinc-700 font-black tracking-widest">Node Tint</label>
                        <input type="color" value="${link.color}" oninput="updateLink(${idx}, 'color', this.value)" class="w-full h-2 bg-zinc-800 rounded-full cursor-pointer appearance-none border-none">
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateLink(index, field, value) {
            appData.links[index][field] = value;
            renderUI();
        }

        function addLink() {
            appData.links.push({ label: "NEW NODE", url: "https://", color: "#333333" });
            renderUI();
        }

        function removeLink(index) {
            appData.links.splice(index, 1);
            renderUI();
        }

        async function saveExperience() {
            if (!user) { navigateTo('login'); return; }
            const btn = document.getElementById('save-btn');
            const status = document.getElementById('db-status-text');
            const statusDot = document.getElementById('db-status-dot');
            const timeText = document.getElementById('last-saved-text');
            
            btn.innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i> Syncing`;
            lucide.createIcons();
            
            try {
                const { error } = await supabaseClient.from('cards').upsert({ 
                    id: currentCardId, 
                    user_id: user.id,
                    config: appData, 
                    updated_at: new Date().toISOString() 
                });

                if (error) throw error;
                showToast("Nexus Synchronized", "success");
                status.innerText = "Synced to Cloud";
                statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                timeText.innerText = "Last Saved: " + new Date().toLocaleTimeString();
            } catch (e) {
                showToast("Nexus Fault", "error");
                console.error(e);
            } finally {
                btn.innerHTML = `<i data-lucide="cloud-upload" class="w-4 h-4"></i> Sync`;
                lucide.createIcons();
            }
        }

        function getCardUrl() {
            return window.location.href.split('?')[0] + "?id=" + currentCardId;
        }

        function copyPublicLink() {
            const url = getCardUrl() + "&view=ar";
            const dummy = document.createElement("input");
            document.body.appendChild(dummy);
            dummy.value = url;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);
            showToast("Hologram URL Copied", "success");
        }

        function renderUI() {
            const workspace = document.getElementById('preview-workspace');
            const cardUrl = getCardUrl();
            const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?data=" + encodeURIComponent(cardUrl + "&view=ar") + "&size=300x300&bgcolor=ffffff";

            if (currentTab === 'physical') {
                workspace.innerHTML = `
                    <div class="flex flex-col gap-16 items-center w-full">
                        <!-- Card Front -->
                        <div id="card-front" class="w-[360px] h-[210px] rounded-[40px] shadow-[0_40px_100px_-20px_rgba(0,0,0,0.8)] relative overflow-hidden flex flex-col p-10 border border-white/10" style="background-color: ${appData.cardColor}; color: ${appData.textColor}">
                            <div class="absolute -right-12 -bottom-12 w-64 h-64 bg-black/5 rounded-full blur-[80px]"></div>
                            <div class="flex items-center gap-6 mb-4 relative z-10">
                                <img src="${appData.profilePic}" class="w-16 h-16 rounded-[24px] border-2 border-current/10 bg-white/5 shadow-2xl object-cover" alt="Avatar">
                                <div class="space-y-1">
                                    <h2 class="text-3xl font-black italic tracking-tighter uppercase leading-none heading-font">${appData.cardHolder}</h2>
                                    <p class="text-[10px] opacity-70 uppercase tracking-[0.4em] font-black">${appData.brandTitle}</p>
                                </div>
                            </div>
                            <div class="flex-1"></div>
                            <div class="flex justify-between items-end pt-6 border-t border-current/10 relative z-10">
                                <div class="text-[9px] mono opacity-40 font-black italic uppercase">ARTIFACT_ID_${currentCardId}</div>
                                <div class="w-12 h-12 bg-current/5 rounded-2xl flex items-center justify-center font-black text-sm shadow-inner ring-1 ring-current/10">513</div>
                            </div>
                        </div>

                        <!-- Card Back -->
                        <div id="card-back" class="w-[360px] h-[210px] bg-white rounded-[40px] shadow-[0_40px_100px_-20px_rgba(0,0,0,0.5)] relative overflow-hidden flex items-center p-8 border-2 border-zinc-200">
                            <div class="w-[155px] h-[155px] bg-black p-4 rounded-[32px] flex items-center justify-center shrink-0 shadow-2xl ring-4 ring-zinc-100">
                                <div class="w-full h-full bg-white p-3.5 flex flex-col items-center justify-center relative rounded-2xl">
                                    <img src="${qrUrl}" class="w-full h-auto" alt="QR">
                                    <div class="absolute -bottom-1 text-[8px] font-black text-black tracking-tighter uppercase scale-90">SCAN NEURAL HUB</div>
                                </div>
                            </div>
                            <div class="flex-1 pl-10 space-y-5">
                                <div>
                                    <h4 class="text-black text-[11px] font-black uppercase mb-1.5 tracking-[0.2em] opacity-40 italic underline decoration-yellow-500 underline-offset-4">Handshake</h4>
                                    <p class="text-black text-[10px] font-bold leading-relaxed opacity-80">1. Deploy Lens<br>2. Scan Dynamic QR<br>3. Frame Hiro Anchor</p>
                                </div>
                                <div class="pt-4 border-t border-zinc-100">
                                    <div class="text-black text-[18px] font-black italic tracking-tighter leading-none heading-font">VingaDeck Hub</div>
                                    <div class="text-[8px] text-zinc-400 font-black uppercase mt-2 tracking-widest">PG513 Systems</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                renderLinksList();
                workspace.innerHTML = `
                    <div class="relative w-full max-w-[480px] h-[580px] flex items-center justify-center select-none perspective-1000">
                        <!-- Base Anchor -->
                        <div class="absolute bottom-20 w-64 h-64 bg-black/50 p-8 rounded-[60px] rotate-x-60 backdrop-blur-3xl border-2 border-white/10 shadow-[0_0_100px_rgba(255,255,255,0.05)] flex flex-col items-center justify-center font-black text-white/5 uppercase italic tracking-[0.5em] text-3xl">HIRO</div>
                        
                        <!-- Floating HUD -->
                        <div class="w-80 h-[340px] rounded-[50px] shadow-[0_0_150px_rgba(0,0,0,1)] flex flex-col p-10 border-2 transition-all duration-1000 ease-out transform-gpu animate-in zoom-in slide-in-from-bottom-20" 
                             style="background-color: #030303; border-color: ${appData.themeColor}; transform: rotateX(${appData.tiltAngle}deg) translateY(-160px) scale(1.15); opacity: ${appData.panelOpacity}; box-shadow: 0 0 80px ${appData.themeColor}1a">
                            
                            <div class="absolute -top-8 -left-8 w-20 h-20 rounded-[30px] bg-zinc-900 border-2 border-white/10 shadow-2xl overflow-hidden ring-4 ring-black ring-offset-4 ring-offset-zinc-950">
                                <img src="${appData.profilePic}" class="w-full h-full object-cover">
                            </div>

                            <h3 class="text-4xl font-black italic text-center mb-1 tracking-tighter uppercase leading-tight heading-font mt-4" style="color: ${appData.themeColor}">${appData.arTitle}</h3>
                            <p class="text-[11px] text-center text-zinc-500 mb-12 uppercase tracking-[0.4em] font-black">${appData.arSubtitle}</p>
                            
                            <div class="grid grid-cols-2 gap-5 mt-auto">
                                ${appData.links.slice(0, 4).map(l => `<div class="h-12 rounded-[20px] flex items-center justify-center text-[9px] font-black tracking-[0.2em] uppercase truncate px-4 text-white border border-white/5 shadow-2xl" style="background-color: ${l.color}">${l.label}</div>`).join('')}
                            </div>
                            
                            <div class="absolute -bottom-24 left-1/2 -translate-x-1/2 w-[2px] h-24 bg-gradient-to-t from-transparent via-yellow-500/10 to-yellow-500/40 animate-pulse"></div>
                        </div>

                        <!-- Orbitals -->
                        <div class="absolute top-10 right-0 w-28 h-28 border border-white/5 rounded-full animate-spin-slow flex items-center justify-center">
                            <div class="w-16 h-16 border-2 border-yellow-500/20 rounded-full animate-pulse flex items-center justify-center">
                                <div class="w-4 h-4 bg-yellow-500 rounded-full blur-sm"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- AR Engine View ---
        function launchAR() {
            const arOverlay = document.getElementById('view-ar-mode');
            const container = document.getElementById('ar-iframe-container');
            arOverlay.classList.remove('hidden');
            
            const linksHtml = appData.links.map((link, i) => {
                const x = (i % 2 === 0 ? -0.9 : 0.9);
                const y = -Math.floor(i / 2) * 0.5;
                return `<a-plane class="clickable" link-to="url: ${link.url}" position="${x} ${y} 0" width="1.7" height="0.45" color="${link.color}"><a-text value="${link.label}" align="center" color="white" width="3.2" font="exo2bold"></a-text></a-plane>`;
            }).join('');

            container.innerHTML = `<iframe class="w-full h-full border-none" allow="camera; accelerometer; gyro; magnetometer; xr-spatial-tracking" srcDoc='
                <!DOCTYPE html>
                <html>
                    <head>
                        <script src="https://aframe.io/releases/1.3.0/aframe.min.js"><\/script>
                        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"><\/script>
                    </head>
                    <body style="margin: 0; overflow: hidden;">
                        <script>
                            AFRAME.registerComponent("link-to", {
                                schema: { url: {type: "string"} },
                                init: function () {
                                    this.el.addEventListener("click", function() { window.open(this.data.url, "_blank"); }.bind(this));
                                }
                            });
                        <\/script>
                        <a-scene embedded arjs="debugUIEnabled: false; trackingMethod: best;">
                            <a-marker preset="hiro">
                                <a-entity position="0 0.7 -1.2" rotation="${appData.tiltAngle} 0 0">
                                    <a-plane width="3.8" height="3.2" color="#050505" opacity="${appData.panelOpacity}" transparent="true" radius="0.3">
                                        <a-image src="${appData.profilePic}" position="0 1.2 0.1" width="0.8" height="0.8" radius="0.1"><\/a-image>
                                        <a-text value="${appData.arTitle}" align="center" position="0 0.6 0.1" color="${appData.themeColor}" width="6.5" font="exo2bold"><\/a-text>
                                        <a-text value="${appData.arSubtitle}" align="center" position="0 0.15 0.1" color="#aaa" width="3.8"><\/a-text>
                                        <a-entity position="0 -0.6 0.1">${linksHtml}<\/a-entity>
                                    <\/a-plane>
                                    <a-torus-knot radius="0.18" radius-tubular="0.01" position="1.8 1.4 0.2" color="${appData.themeColor}" animation="property: rotation; to: 0 360 0; loop: true; dur: 7000"><\/a-torus-knot>
                                <\/a-entity>
                            <\/a-marker>
                            <a-entity camera><a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"><\/a-entity><\/a-entity>
                        <\/a-scene>
                    </body>
                </html>'></iframe>`;
            lucide.createIcons();
        }

        function closeAR() {
            document.getElementById('view-ar-mode').classList.add('hidden');
            document.getElementById('ar-iframe-container').innerHTML = '';
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');
            toastMsg.innerText = msg;
            icon.innerHTML = type === 'success' ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>' : '<i data-lucide="alert-octagon" class="w-5 h-5 text-red-500"></i>';
            lucide.createIcons();
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3500);
        }

        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const mode = params.get('view');
            if (id) {
                currentCardId = id;
                const { data } = await supabaseClient.from('cards').select('config').eq('id', id).single();
                if (data && data.config) {
                    appData = data.config;
                    if (mode === 'ar') launchAR();
                    else navigateTo('studio');
                }
            }
        }
    </script>
</body>
</html>
